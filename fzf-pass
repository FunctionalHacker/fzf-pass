#!/usr/bin/env bash

cd $HOME/.password-store
PASSFILE=$(tree -Ffi | grep '.gpg' | sed 's/.gpg$//g' | sed 's/^..//' | fzf)

if [ -z "$PASSFILE" ]; then
	exit 0
fi

PASSDATA="$(pass $PASSFILE)"
USRNAME="$(echo "$PASSDATA" | egrep -i "username:|user:" | head -1 | cut -d' ' -f2-)"
PASS="$(echo "$PASSDATA" | head -n 1)"
URL="$(echo $PASSDATA | grep url: | cut -d' ' -f2-)"

RESP=$(cat <<EOF | fzf
Autotype
Username
Password
OTP
URL
EOF
);

case "$RESP" in
	Autotype)
		swaymsg exec "ydotool type \"${USRNAME}\" \
		  && ydotool key TAB \
		  && ydotool type \"${PASS}\" \
		  && ydotool key Enter"
		;;
	Username)
		swaymsg exec "ydotool type \"${USRNAME}\""
		;;
	Password)
		swaymsg exec "ydotool type \"${PASS}\""
		;;
	OTP)
		# sourcing ~/.profile  is required in case
		# PASSWORD_STORE_ENABLE_EXTENSIONS is set.
		swaymsg exec "source ~/.profile \
		  && ydotool type \"$(pass otp "${PASSFILE}")"
		;;
	URL)
		swaymsg exec "ydotool type \"${URL}\""
		;;
	*)
		exit 1
esac
